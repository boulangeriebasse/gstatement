<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銀幕一楼とTIMECAFE 会計ツール</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .serif { font-family: 'Noto Serif JP', serif; }
        
        @media print {
            @page { margin: 0; size: A4; }
            body { -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-container { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 100% !important; 
                max-width: 100% !important;
                padding: 40px !important;
                position: absolute;
                top: 0;
                left: 0;
            }
            /* 印刷時に背景色を強制的に出すためのハック */
            .bg-gray-100 { background-color: #f3f4f6 !important; }
            .bg-indigo-100 { background-color: #e0e7ff !important; }
            .bg-emerald-100 { background-color: #d1fae5 !important; }
            .bg-gray-200 { background-color: #e5e7eb !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 pb-10">

    <!-- Header (No Print) -->
    <header class="bg-indigo-900 text-white p-4 shadow-md no-print">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="file-text" class="w-6 h-6"></i>
                銀幕一楼とTIMECAFE 会計ツール
            </h1>
            <div class="text-xs opacity-80 md:block hidden">
                手渡し支払い版 (HTML)
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto md:p-6 p-2 flex flex-col md:flex-row gap-6">
        
        <!-- Left Column: Input Form (No Print) -->
        <section class="flex-1 bg-white rounded-xl shadow-lg p-6 no-print h-fit">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-lg font-bold text-gray-700">データ入力</h2>
                <button onclick="resetData()" class="text-xs flex items-center gap-1 text-gray-500 hover:text-red-500 transition-colors">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> リセット
                </button>
            </div>

            <div class="space-y-4">
                <!-- Basic Info -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">発行日</label>
                        <input type="date" id="issueDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none" onchange="updatePreview()">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">支払日（手渡し日）</label>
                        <input type="date" id="paymentDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none" onchange="updatePreview()">
                    </div>
                </div>

                <!-- Member Selection -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">メンバー名（宛名）</label>
                    <div class="flex flex-col gap-2">
                        <select id="memberSelect" class="w-full p-2 border rounded bg-gray-50 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" onchange="handleMemberSelect()">
                            <option value="">リストから選択...</option>
                            <option value="銀幕一楼">銀幕一楼</option>
                            <option value="松永健太">松永健太</option>
                            <option value="瀬間絢子">瀬間絢子</option>
                            <option value="塚原嵩">塚原嵩</option>
                            <option value="野口紗依子">野口紗依子</option>
                            <option value="くりあげ">くりあげ</option>
                            <option value="">（手入力/その他）</option>
                        </select>
                        <input type="text" id="memberName" placeholder="メンバー名を手入力" class="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-indigo-500 outline-none" oninput="updatePreview()">
                    </div>
                </div>

                <!-- Fees -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <label class="block text-sm font-bold text-indigo-900 mb-2">① 出演料（ギャラ）</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">¥</span>
                        <input type="number" id="performanceFee" placeholder="30000" class="w-full pl-8 p-2 border rounded bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-lg" oninput="updatePreview()">
                    </div>
                </div>

                <!-- Expenses -->
                <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold text-emerald-900">② 立替経費（交通費・消耗品など）</label>
                        <button onclick="addExpense()" class="text-xs bg-emerald-600 text-white px-2 py-1 rounded hover:bg-emerald-700 flex items-center gap-1 transition-colors">
                            <i data-lucide="plus" class="w-3 h-3"></i> 追加
                        </button>
                    </div>
                    
                    <div id="expensesList" class="space-y-3">
                        <!-- Expense items will be injected here via JS -->
                    </div>

                    <div class="mt-3 text-right text-sm text-emerald-800 font-bold border-t border-emerald-200 pt-2">
                        経費計: ¥<span id="inputExpenseTotal">0</span>
                    </div>
                </div>

                <!-- Memo -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">自由記載欄（備考）</label>
                    <textarea id="memo" placeholder="必要があれば入力してください" class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none h-20" oninput="updatePreview()"></textarea>
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                 <button onclick="window.print()" class="flex-1 bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 shadow-lg transition-all">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                    PDF発行 / 印刷
                </button>
                <button onclick="copyToClipboard()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 shadow-lg transition-all">
                    <i data-lucide="copy" class="w-5 h-5"></i>
                    LINE用コピー
                </button>
            </div>
            <div class="mt-2 text-center text-xs text-gray-400">
                ※PDF発行は、印刷画面で「PDFとして保存」を選択してください。
            </div>
        </section>

        <!-- Right Column: Preview (Print Area) -->
        <section class="flex-1 flex justify-center items-start no-print-bg">
            <div class="bg-white p-10 shadow-2xl rounded-sm print-container w-full max-w-[210mm] min-h-[297mm] relative serif">
                
                <!-- Document Header -->
                <div class="border-b-2 border-gray-800 pb-4 mb-8 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2 tracking-widest">支払明細書</h1>
                        <p class="text-sm text-gray-500">兼 経費精算書</p>
                    </div>
                    <div class="text-right text-sm text-gray-600">
                        <p>No: <span id="previewSlipNumber"></span></p>
                        <p>発行日: <span id="previewIssueDate"></span></p>
                    </div>
                </div>

                <!-- Recipient & Total -->
                <div class="flex flex-col md:flex-row justify-between gap-8 mb-10">
                    <div class="flex-1">
                        <div class="border-b border-gray-300 pb-1 mb-1">
                            <span id="previewMemberName" class="text-xl font-bold mr-2">（メンバー名）</span> 
                            <span class="text-sm text-gray-600">様</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            以下の通り、出演料および立替経費をお支払いいたします。
                        </p>
                    </div>

                    <div class="bg-gray-100 p-4 rounded w-full md:w-64">
                        <div class="text-xs text-gray-500 mb-1">支払金額合計</div>
                        <div class="text-3xl font-bold text-gray-900 border-b-2 border-gray-400 pb-2 mb-2">
                            ¥<span id="previewGrandTotal">0</span>
                        </div>
                        <div class="text-xs text-gray-600 flex justify-between">
                           <span>支払日:</span>
                           <span id="previewPaymentDate" class="font-semibold"></span>
                        </div>
                    </div>
                </div>

                <!-- Summary Box -->
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-gray-700 bg-gray-200 p-2 mb-2 border-l-4 border-gray-800">
                        お支払い内訳
                    </h3>
                    <table class="w-full text-sm">
                         <tbody>
                           <tr class="border-b">
                             <td class="py-2 pl-2">1. 出演料・報酬計 <span class="text-xs text-gray-500">（課税対象）</span></td>
                             <td class="py-2 pr-2 text-right font-medium">¥<span id="previewFeeTotal">0</span></td>
                           </tr>
                           <tr class="border-b">
                             <td class="py-2 pl-2">2. 立替経費精算計 <span class="text-xs text-gray-500">（非課税）</span></td>
                             <td class="py-2 pr-2 text-right font-medium">¥<span id="previewExpenseTotal">0</span></td>
                           </tr>
                           <tr class="bg-gray-50">
                             <td class="py-2 pl-2 font-bold">合計</td>
                             <td class="py-2 pr-2 text-right font-bold">¥<span id="previewSummaryTotal">0</span></td>
                           </tr>
                         </tbody>
                    </table>
                </div>

                <!-- Details Table -->
                <div class="mb-12">
                    <h3 class="text-sm font-bold text-gray-700 mb-2 pl-2">
                        詳細明細
                    </h3>
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-800 text-gray-600 text-left">
                                <th class="py-2 pl-2 font-normal w-1/5">日付</th>
                                <th class="py-2 font-normal w-2/5">摘要（内容）</th>
                                <th class="py-2 font-normal text-center w-1/5">区分</th>
                                <th class="py-2 pr-2 font-normal text-right w-1/5">金額</th>
                            </tr>
                        </thead>
                        <tbody id="previewDetailsBody">
                            <!-- JS will inject rows here -->
                        </tbody>
                    </table>
                </div>

                <!-- Memo Section -->
                <div id="previewMemoContainer" class="mb-8 p-4 border border-gray-300 rounded text-sm text-gray-700 hidden">
                    <p class="font-bold mb-1 text-xs text-gray-500">備考</p>
                    <p id="previewMemoContent" class="whitespace-pre-wrap"></p>
                </div>

                <!-- Footer -->
                <div class="absolute bottom-10 right-10 left-10 pt-4 border-t border-gray-300 flex justify-between items-end">
                    <div class="text-xs text-gray-400">
                        Generated by Band Accounting Tool
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg mb-1">銀幕一楼とTIMECAFE</div>
                        <div class="text-xs text-gray-500">
                            経理担当
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <script>
        // --- Init State ---
        const today = new Date().toISOString().split('T')[0];
        let expenses = [
            { id: Date.now(), date: today, description: '交通費', amount: '' }
        ];
        const slipNumber = new Date().getTime().toString().slice(-6);

        // --- Init DOM ---
        document.getElementById('issueDate').value = today;
        document.getElementById('paymentDate').value = today;
        document.getElementById('previewSlipNumber').textContent = slipNumber;

        // Initialize
        renderExpensesInput();
        updatePreview();
        lucide.createIcons();

        // --- Functions ---

        function handleMemberSelect() {
            const select = document.getElementById('memberSelect');
            const input = document.getElementById('memberName');
            if (select.value) {
                input.value = select.value;
            }
            // If select value is empty, we don't clear input automatically to allow manual typing
            // unless user explicitly selected the empty option, but input handles that naturally.
            updatePreview();
        }

        function addExpense() {
            const dateVal = document.getElementById('issueDate').value;
            expenses.push({ 
                id: Date.now(), 
                date: dateVal, 
                description: '', 
                amount: '' 
            });
            renderExpensesInput();
            updatePreview();
        }

        function removeExpense(id) {
            expenses = expenses.filter(e => e.id !== id);
            renderExpensesInput();
            updatePreview();
        }

        function updateExpense(id, field, value) {
            const exp = expenses.find(e => e.id === id);
            if (exp) {
                exp[field] = value;
                updatePreview();
            }
        }

        function renderExpensesInput() {
            const container = document.getElementById('expensesList');
            container.innerHTML = '';

            expenses.forEach(exp => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 items-start';
                div.innerHTML = `
                    <div class="flex-1 space-y-2">
                        <div class="flex gap-2">
                            <input type="date" value="${exp.date}" 
                                onchange="updateExpense(${exp.id}, 'date', this.value)"
                                class="w-1/3 text-xs p-2 border rounded">
                            <input type="text" value="${exp.description}" 
                                oninput="updateExpense(${exp.id}, 'description', this.value)"
                                placeholder="項目（例: スタジオ代）"
                                class="w-2/3 text-xs p-2 border rounded">
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-400 text-xs">¥</span>
                            <input type="number" value="${exp.amount}" 
                                oninput="updateExpense(${exp.id}, 'amount', this.value)"
                                placeholder="金額"
                                class="w-full pl-6 p-2 text-sm border rounded font-mono">
                        </div>
                    </div>
                    ${expenses.length > 0 ? `
                    <button onclick="removeExpense(${exp.id})" class="text-gray-400 hover:text-red-500 mt-2 p-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                    ` : ''}
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function updatePreview() {
            // Get values
            const issueDate = document.getElementById('issueDate').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const memberName = document.getElementById('memberName').value;
            const feeVal = Number(document.getElementById('performanceFee').value) || 0;
            const memoVal = document.getElementById('memo').value;

            // Calculate Expenses
            const expenseTotal = expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
            const grandTotal = feeVal + expenseTotal;

            // Update UI Text
            document.getElementById('inputExpenseTotal').textContent = expenseTotal.toLocaleString();
            
            // Preview Header
            document.getElementById('previewIssueDate').textContent = formatDateJP(issueDate);
            document.getElementById('previewMemberName').textContent = memberName || '（メンバー名）';
            
            // Preview Totals
            document.getElementById('previewGrandTotal').textContent = grandTotal.toLocaleString();
            document.getElementById('previewPaymentDate').textContent = formatDateJP(paymentDate);
            
            // Preview Summary Table
            document.getElementById('previewFeeTotal').textContent = feeVal.toLocaleString();
            document.getElementById('previewExpenseTotal').textContent = expenseTotal.toLocaleString();
            document.getElementById('previewSummaryTotal').textContent = grandTotal.toLocaleString();

            // Preview Details Table
            const tbody = document.getElementById('previewDetailsBody');
            tbody.innerHTML = '';

            // 1. Fee Row
            if (feeVal > 0) {
                tbody.innerHTML += `
                    <tr class="border-b border-gray-200">
                        <td class="py-3 pl-2">${formatDateJP(issueDate)}</td>
                        <td class="py-3">出演料（ギャラ）として</td>
                        <td class="py-3 text-center text-xs">
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded">報酬</span>
                        </td>
                        <td class="py-3 pr-2 text-right">¥${feeVal.toLocaleString()}</td>
                    </tr>
                `;
            }

            // 2. Expense Rows
            expenses.forEach(exp => {
                if (exp.amount) {
                    tbody.innerHTML += `
                        <tr class="border-b border-gray-200">
                            <td class="py-3 pl-2">${exp.date ? formatDateJP(exp.date) : '-'}</td>
                            <td class="py-3">${exp.description || '（経費）'}</td>
                            <td class="py-3 text-center text-xs">
                                <span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded">経費</span>
                            </td>
                            <td class="py-3 pr-2 text-right">¥${Number(exp.amount).toLocaleString()}</td>
                        </tr>
                    `;
                }
            });

            // 3. Filler Rows (for aesthetics)
            const currentRowCount = (feeVal > 0 ? 1 : 0) + expenses.filter(e => e.amount).length;
            if (currentRowCount < 3) {
                for (let i = 0; i < (3 - currentRowCount); i++) {
                    tbody.innerHTML += `
                        <tr class="border-b border-gray-100 text-transparent">
                            <td class="py-3 pl-2">-</td>
                            <td class="py-3">-</td>
                            <td class="py-3">-</td>
                            <td class="py-3 pr-2">-</td>
                        </tr>
                    `;
                }
            }

            // Preview Memo
            const memoContainer = document.getElementById('previewMemoContainer');
            if (memoVal) {
                memoContainer.classList.remove('hidden');
                document.getElementById('previewMemoContent').textContent = memoVal;
            } else {
                memoContainer.classList.add('hidden');
            }
        }

        function formatDateJP(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function copyToClipboard() {
            const issueDate = document.getElementById('issueDate').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const memberName = document.getElementById('memberName').value;
            const feeVal = Number(document.getElementById('performanceFee').value) || 0;
            const expenseTotal = expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
            const grandTotal = feeVal + expenseTotal;

            const text = `
【支払明細（手渡し）】
${memberName} 様

お疲れ様です。
${new Date(issueDate).toLocaleDateString()}発行分の支払明細です。

■支払合計: ¥${grandTotal.toLocaleString()}
（内訳: 出演料 ¥${feeVal.toLocaleString()} / 立替経費 ¥${expenseTotal.toLocaleString()}）

■支払日: ${new Date(paymentDate).toLocaleDateString()}

ご確認よろしくお願いいたします。
銀幕一楼とTIMECAFE 経理
            `.trim();

            navigator.clipboard.writeText(text).then(() => {
                alert('LINE用のメッセージをコピーしました！');
            });
        }

        function resetData() {
            if (confirm('入力をすべてリセットしますか？')) {
                document.getElementById('memberName').value = '';
                document.getElementById('memberSelect').value = '';
                document.getElementById('performanceFee').value = '';
                document.getElementById('memo').value = '';
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('issueDate').value = today;
                document.getElementById('paymentDate').value = today;
                
                expenses = [{ id: Date.now(), date: today, description: '交通費', amount: '' }];
                
                renderExpensesInput();
                updatePreview();
            }
        }
    </script>
</body>
</html>
